<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LMod Workshop</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    header {
      background: #222;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 36px;
    }

    #uploadForm {
      background: #1c1c1c;
      padding: 20px;
      text-align: center;
    }

    #uploadForm input, #uploadForm label {
      margin: 10px;
      display: block;
      font-size: 16px;
    }

    #uploadForm input[type="text"] {
      padding: 5px;
      width: 300px;
    }

    .workshop-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
      gap: 20px;
    }

    .mod-box {
      background: #222;
      border: 1px solid #444;
      border-radius: 10px;
      width: 400px;
      box-shadow: 0 0 10px #000;
      overflow: hidden;
      position: relative;
    }

    .mod-image {
      width: 100%;
      height: 200px;
      background-size: cover;
      background-position: center;
      border-bottom: 1px solid #444;
    }

    .mod-info {
      padding: 15px;
    }

    .mod-title {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .mod-author {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 10px;
    }

    .subscribe-btn, .delete-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      font-weight: bold;
    }

    .subscribe-btn:hover {
      background: #45a049;
    }

    .delete-btn {
      background: #e74c3c;
    }

    .delete-btn:hover {
      background: #c0392b;
    }

    .btn-group {
      display: flex;
      justify-content: flex-start;
      gap: 10px;
    }
  </style>
</head>
<body>

<header>
  <h1>LMod Workshop</h1>
  <p>Upload and browse custom content for LMod</p>
</header>

<!-- Upload form -->
<div id="uploadForm">
  <h2>Upload a Mod</h2>
  <label>Mod Name: <input type="text" id="modName" /></label>
  <label>Author: <input type="text" id="modAuthor" value="LEMONTECH" /></label>
  <label>.json File: <input type="file" id="modFile" accept=".json" /></label>
  <label>Preview Image (.png): <input type="file" id="modImage" accept="image/png" /></label>
  <button onclick="uploadMod()">Add to Workshop</button>
</div>

<!-- Workshop section -->
<div class="workshop-container" id="workshopList"></div>

<script>
let mods = [];

function saveMods() {
  try {
    localStorage.setItem("lmodMods", JSON.stringify(mods));
  } catch(e) {
    console.error("Error saving mods to localStorage", e);
  }
}

function loadMods() {
  try {
    const saved = localStorage.getItem("lmodMods");
    if (saved) {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed)) {
        mods = parsed;
        mods.forEach(renderMod);
      } else {
        mods = [];
      }
    }
  } catch (e) {
    console.error("Error loading mods from localStorage", e);
    mods = [];
  }
}

function uploadMod() {
  const name = document.getElementById("modName").value.trim();
  const author = document.getElementById("modAuthor").value.trim();
  const jsonFile = document.getElementById("modFile").files[0];
  const imageFile = document.getElementById("modImage").files[0];

  if (!name || !author || !jsonFile || !imageFile) {
    alert("Please fill in all fields and select files.");
    return;
  }

  const readerImg = new FileReader();
  const readerJSON = new FileReader();

  readerImg.onload = function(e) {
    const imageUrl = e.target.result;

    readerJSON.onload = function(ev) {
      const jsonData = ev.target.result;

      const modData = {
        id: Date.now() + Math.random().toString(36).slice(2), // unikalny ID
        name,
        author,
        imageUrl,
        jsonContent: jsonData,
        jsonFileName: jsonFile.name
      };

      mods.push(modData);
      saveMods();
      renderMod(modData);

      // Wyczyść formularz
      document.getElementById("modName").value = "";
      document.getElementById("modAuthor").value = "LEMONTECH";
      document.getElementById("modFile").value = "";
      document.getElementById("modImage").value = "";
    };

    readerJSON.readAsText(jsonFile);
  };

  readerImg.readAsDataURL(imageFile);
}

function renderMod(mod) {
  const container = document.getElementById("workshopList");

  // Sprawdź, czy mod już jest na stronie (np. po reloadzie)
  if(document.getElementById(mod.id)) return;

  const modBox = document.createElement("div");
  modBox.className = "mod-box";
  modBox.id = mod.id;

  const imageDiv = document.createElement("div");
  imageDiv.className = "mod-image";
  imageDiv.style.backgroundImage = `url(${mod.imageUrl})`;

  const infoDiv = document.createElement("div");
  infoDiv.className = "mod-info";

  const title = document.createElement("div");
  title.className = "mod-title";
  title.textContent = mod.name;

  const authorText = document.createElement("div");
  authorText.className = "mod-author";
  authorText.textContent = "Author: " + mod.author;

  const btnSubscribe = document.createElement("button");
  btnSubscribe.className = "subscribe-btn";
  btnSubscribe.textContent = "Subscribe";
  btnSubscribe.onclick = () => {
    const blob = new Blob([mod.jsonContent], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = mod.jsonFileName || "mod.json";
    a.click();
  };

  const btnDelete = document.createElement("button");
  btnDelete.className = "delete-btn";
  btnDelete.textContent = "Delete";
  btnDelete.onclick = () => {
    if (confirm(`Delete mod "${mod.name}"?`)) {
      mods = mods.filter(m => m.id !== mod.id);
      saveMods();
      modBox.remove();
    }
  };

  const btnGroup = document.createElement("div");
  btnGroup.className = "btn-group";
  btnGroup.appendChild(btnSubscribe);
  btnGroup.appendChild(btnDelete);

  infoDiv.appendChild(title);
  infoDiv.appendChild(authorText);
  infoDiv.appendChild(btnGroup);

  modBox.appendChild(imageDiv);
  modBox.appendChild(infoDiv);

  container.appendChild(modBox);
}

loadMods();
</script>

</body>
</html>
